<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>mdzyart</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Pinch Zoom -->
  <script src="https://cdn.jsdelivr.net/npm/pinch-zoom-js@2.3.4/dist/pinch-zoom.umd.min.js"></script>
  <!-- Cute Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@700&family=Pacifico&display=swap" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(135deg, #e3f0ff 0%, #b3e0ff 100%);
      font-family: 'Quicksand', 'Comic Sans MS', cursive, sans-serif;
      color: #1976d2;
      min-height: 100vh;
    }
    .cute-app-title {
      font-family: 'Pacifico', 'Quicksand', cursive, sans-serif;
      font-size: 2.5rem;
      color: #1976d2;
      letter-spacing: 2px;
      text-shadow: 0 2px 8px #fff8;
      margin-top: 24px;
      margin-bottom: 12px;
      user-select: none;
      pointer-events: none;
    }
    .cute-title {
      font-size: 3rem;
      font-weight: 700;
      letter-spacing: 2px;
      color: #1976d2;
      text-shadow: 0 2px 8px #fff8;
    }
    .arrow {
      animation: bounce 1.2s infinite;
    }
    @keyframes bounce {
      0%, 100% { transform: translateY(0);}
      50% { transform: translateY(12px);}
    }
    .btn-cute {
      background: #7ecbff;
      color: #1976d2;
      border-radius: 24px;
      font-weight: 600;
      font-size: 1.2rem;
      border: none;
      box-shadow: 0 2px 8px #b3e0ff88;
      transition: background 0.2s;
    }
    .btn-cute:hover, .btn-cute:focus {
      background: #b3e0ff;
      color: #1976d2;
    }
    #main-card {
      background: #fff;
      border-radius: 24px;
      box-shadow: 0 8px 32px rgba(60,60,120,0.12);
      padding: 32px 16px;
      margin: 40px auto 0 auto;
      max-width: 960px;
    }
    #canvas-container {
      background: #f5f7fa;
      border-radius: 16px;
      box-shadow: 0 2px 8px rgba(60,60,120,0.08);
      padding: 16px;
      margin-bottom: 20px;
      overflow: hidden;
    }
    pinch-zoom {
      display: block;
      width: 100%;
      height: 100%;
      border-radius: 12px;
    }
    #canvas {
      background: #fff;
      border-radius: 10px;
      touch-action: none;
      width: 100%;
      max-width: 900px;
      height: 500px;
      display: block;
      margin: 0 auto;
      border: 2px solid #7ecbff;
      box-shadow: 0 2px 8px #b3e0ff44;
    }
    .color-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: 2px solid #fff;
      margin-right: 6px;
      margin-left: 0;
      box-shadow: 0 1px 4px #b3e0ff44;
      transition: border 0.2s;
    }
    .color-btn.selected {
      border: 2px solid #1976d2;
      box-shadow: 0 2px 8px #1976d244;
    }
    #custom-color {
      width: 36px;
      height: 36px;
      border: none;
      border-radius: 50%;
      margin-left: 6px;
      box-shadow: 0 1px 4px #b3e0ff44;
      padding: 0;
    }
    #chat-box {
      background: #e3f2fd;
      color: #222;
      border-radius: 10px;
      max-height: 200px;
      overflow-y: auto;
      padding: 10px;
      margin-bottom: 10px;
      font-size: 1.05rem;
    }
    #chat-form, #color-row {
      display: flex;
      gap: 8px;
      justify-content: center;
      margin-bottom: 10px;
    }
    #clear-btn, #leave-btn, #music-toggle {
      border-radius: 20px;
      font-weight: 600;
      font-size: 1.1rem;
      border: none;
      box-shadow: 0 2px 8px #b3e0ff44;
      margin-right: 8px;
    }
    #clear-btn {
      background: #ffe082;
      color: #b28704;
    }
    #clear-btn:hover, #clear-btn:focus {
      background: #fff8e1;
      color: #b28704;
    }
    #leave-btn {
      background: #ffb3b3;
      color: #d32f2f;
    }
    #leave-btn:hover, #leave-btn:focus {
      background: #ffeaea;
      color: #d32f2f;
    }
    #music-toggle {
      background: #b3e0ff;
      color: #1976d2;
    }
    #music-toggle:hover, #music-toggle:focus {
      background: #e3f0ff;
      color: #1976d2;
    }
    @media (max-width: 900px) {
      #canvas { height: 300px; }
    }
    @media (max-width: 600px) {
      #main-card { padding: 12px 2px; }
      #canvas { height: 200px; }
      .cute-title { font-size: 2rem; }
      .cute-app-title { font-size: 1.5rem; }
    }
  </style>
</head>
<body>
  <!-- Cute App Title -->
  <div class="cute-app-title text-center my-3">mdzy art place</div>

  <!-- Welcome Modal -->
  <div class="modal fade" id="welcomeModal" tabindex="-1" aria-labelledby="welcomeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content" style="border-radius: 24px;">
        <div class="modal-header border-0">
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body text-center py-5">
          <h1 class="cute-title mb-4">Let's draw!</h1>
          <div class="arrow mb-4">
            <svg width="40" height="40" viewBox="0 0 24 24"><path fill="#1976d2" d="M12 16.5l-8-8 1.41-1.42L12 13.67l6.59-6.59L20 8.5z"/></svg>
          </div>
          <button id="join-btn" class="btn btn-cute px-5 py-2">Join</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Main App -->
  <div id="main-app">
    <div id="main-card">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <button id="leave-btn" class="btn" style="display:inline-block;">Leave</button>
        </div>
        <div>
          <button id="music-toggle" class="btn" title="Toggle music">ðŸ”Š</button>
        </div>
      </div>
      <div id="color-row" class="mb-2">
        <button class="color-btn" data-color="#1976d2" style="background:#1976d2;" title="Blue"></button>
        <button class="color-btn" data-color="#e53935" style="background:#e53935;" title="Red"></button>
        <button class="color-btn" data-color="#43a047" style="background:#43a047;" title="Green"></button>
        <button class="color-btn" data-color="#fbc02d" style="background:#fbc02d;" title="Yellow"></button>
        <button class="color-btn" data-color="#8e24aa" style="background:#8e24aa;" title="Purple"></button>
        <input type="color" id="custom-color" value="#1976d2" title="Custom color">
        <button id="clear-btn" class="btn">Clear</button>
      </div>
      <div id="canvas-container">
        <pinch-zoom>
          <canvas id="canvas" width="900" height="500"></canvas>
        </pinch-zoom>
      </div>
      <div id="chat-box"></div>
      <form id="chat-form" autocomplete="off">
        <input type="text" id="chat-input" class="form-control" placeholder="Type a message..." style="max-width: 300px;">
        <button type="submit" class="btn btn-cute">Send</button>
      </form>
    </div>
  </div>

  <!-- Background Music -->
  <audio id="bg-music" src="cute.mp3" loop></audio>

  <!-- Bootstrap JS (for modal) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Socket.IO -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script>
    // === CONFIG ===
    // CHANGE THIS to your backend URL!
    const SERVER_URL = 'https://mdzyart.onrender.com'; // <--- CHANGE THIS if needed

    // === SOCKET.IO ===
    const socket = io(SERVER_URL);

    // === Modal logic ===
    const welcomeModalEl = document.getElementById('welcomeModal');
    const welcomeModal = new bootstrap.Modal(welcomeModalEl);
    let joined = false;
    let currentRoom = 'default';

    document.getElementById('join-btn').onclick = () => {
      joined = true;
      welcomeModal.hide();
      socket.emit('joinRoom', currentRoom);
    };
    document.getElementById('leave-btn').onclick = () => {
      joined = false;
      welcomeModal.show();
      socket.emit('leaveRoom', currentRoom);
    };

    // Optionally, auto-join if modal is closed by close button or outside click
    welcomeModalEl.addEventListener('hidden.bs.modal', () => {
      if (!joined) {
        // You can auto-join here if you want, or do nothing
        // socket.emit('joinRoom', currentRoom);
      }
    });

    // === Music ===
    const music = document.getElementById('bg-music');
    const musicToggle = document.getElementById('music-toggle');
    music.volume = 0.5;
    let musicOn = false;
    // Autoplay may be blocked until user interacts
    musicToggle.onclick = () => {
      if (music.paused) {
        music.play();
        musicToggle.textContent = 'ðŸ”Š';
        musicOn = true;
      } else {
        music.pause();
        musicToggle.textContent = 'ðŸ”ˆ';
        musicOn = false;
      }
    };
    // Try to play after user joins
    document.getElementById('join-btn').addEventListener('click', () => {
      setTimeout(() => {
        if (!musicOn) {
          music.play().catch(()=>{});
          musicToggle.textContent = 'ðŸ”Š';
          musicOn = true;
        }
      }, 500);
    });

    // === Color Picker ===
    let currentColor = '#1976d2';
    function selectColor(color) {
      currentColor = color;
      document.querySelectorAll('.color-btn').forEach(btn => {
        btn.classList.toggle('selected', btn.getAttribute('data-color') === color);
      });
      document.getElementById('custom-color').value = color;
    }
    document.querySelectorAll('.color-btn').forEach(btn => {
      btn.onclick = () => selectColor(btn.getAttribute('data-color'));
    });
    document.getElementById('custom-color').oninput = (e) => {
      currentColor = e.target.value;
      document.querySelectorAll('.color-btn').forEach(btn => btn.classList.remove('selected'));
    };
    // Set initial color
    selectColor('#1976d2');

    // === Canvas Drawing ===
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let drawing = false, last = null;

    function getPos(e) {
      const rect = canvas.getBoundingClientRect();
      let clientX, clientY;
      if (e.touches && e.touches.length > 0) {
        clientX = e.touches[0].clientX;
        clientY = e.touches[0].clientY;
      } else if (e.changedTouches && e.changedTouches.length > 0) {
        clientX = e.changedTouches[0].clientX;
        clientY = e.changedTouches[0].clientY;
      } else {
        clientX = e.clientX;
        clientY = e.clientY;
      }
      return {
        x: (clientX - rect.left) * (canvas.width / rect.width),
        y: (clientY - rect.top) * (canvas.height / rect.height)
      };
    }

    function drawLine(from, to, color = currentColor, emit = true) {
      ctx.strokeStyle = color;
      ctx.lineWidth = 3;
      ctx.lineCap = 'round';
      ctx.beginPath();
      ctx.moveTo(from.x, from.y);
      ctx.lineTo(to.x, to.y);
      ctx.stroke();
      ctx.closePath();
      if (emit && currentRoom) {
        socket.emit('draw', { room: currentRoom, data: { from, to, color } });
      }
    }

    function startDraw(e) {
      if (!currentRoom) return;
      drawing = true;
      last = getPos(e);
      e.preventDefault();
    }
    function moveDraw(e) {
      if (!drawing || !currentRoom) return;
      const pos = getPos(e);
      drawLine(last, pos, currentColor, true);
      last = pos;
      e.preventDefault();
    }
    function endDraw(e) {
      drawing = false;
      last = null;
      if (e) e.preventDefault();
    }

    // Mouse events
    canvas.addEventListener('mousedown', startDraw);
    canvas.addEventListener('mousemove', moveDraw);
    canvas.addEventListener('mouseup', endDraw);
    canvas.addEventListener('mouseleave', endDraw);

    // Touch events
    canvas.addEventListener('touchstart', startDraw, { passive: false });
    canvas.addEventListener('touchmove', moveDraw, { passive: false });
    canvas.addEventListener('touchend', endDraw, { passive: false });
    canvas.addEventListener('touchcancel', endDraw, { passive: false });

    // Receive drawing from others
    socket.on('draw', data => {
      drawLine(data.from, data.to, data.color, false);
    });

    // === Clear Canvas ===
    const clearBtn = document.getElementById('clear-btn');
    function clearCanvas(emit = true) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      if (emit && currentRoom) {
        socket.emit('clear', { room: currentRoom });
      }
    }
    clearBtn.onclick = () => clearCanvas();

    socket.on('clear', () => clearCanvas(false));

    // === Clear canvas on join ===
    socket.on('system', msg => {
      if (msg.includes('joined')) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      }
    });

    // === Chat ===
    const chatBox = document.getElementById('chat-box');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');

    function addMessage(msg, system = false) {
      const div = document.createElement('div');
      div.innerHTML = msg;
      if (system) div.style.fontStyle = 'italic';
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    socket.on('chat', ({ id, message }) => {
      addMessage(`<b>${id}:</b> ${message}`);
    });
    socket.on('system', msg => addMessage(`<span style="color:#1976d2">${msg}</span>`, true));

    chatForm.onsubmit = e => {
      e.preventDefault();
      if (!currentRoom) return;
      const msg = chatInput.value.trim();
      if (!msg) return;
      socket.emit('chat', { room: currentRoom, message: msg });
      chatInput.value = '';
    };
  </script>
</body>
</html>
