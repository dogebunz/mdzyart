<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>mdzy art place</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Pinch Zoom -->
  <script src="https://cdn.jsdelivr.net/npm/pinch-zoom-js@2.3.4/dist/pinch-zoom.umd.min.js"></script>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@700&family=Baloo+2:wght@700&display=swap" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(135deg, #e3f0ff 0%, #b3e0ff 100%);
      font-family: 'Quicksand', 'Comic Sans MS', cursive, sans-serif;
      color: #1976d2;
      min-height: 100vh;
    }
    .cute-app-title {
      font-family: 'Baloo 2', cursive, sans-serif;
      font-size: 2.5rem;
      color: #1976d2;
      letter-spacing: 2px;
      text-shadow: 0 2px 8px #fff8;
      margin-top: 24px;
      margin-bottom: 12px;
      user-select: none;
      pointer-events: none;
    }
    .cute-title {
      font-size: 3rem;
      font-weight: 700;
      letter-spacing: 2px;
      color: #1976d2;
      text-shadow: 0 2px 8px #fff8;
      font-family: 'Baloo 2', cursive, sans-serif;
    }
    .arrow {
      animation: bounce 1.2s infinite;
    }
    @keyframes bounce {
      0%, 100% { transform: translateY(0);}
      50% { transform: translateY(12px);}
    }
    /* Rounded, bold, small buttons */
    .btn, .btn-cute, .btn-primary, .btn-success, .btn-light {
      border-radius: 1rem !important;
      font-weight: 600;
      box-shadow: none;
      border: none;
      letter-spacing: 1px;
      padding: 8px 16px;
      transition: background 0.2s, color 0.2s;
      font-size: 1rem;
    }
    .btn-sm, .btn-cute.btn-sm, .btn-primary.btn-sm, .btn-success.btn-sm, .btn-light.btn-sm {
      font-size: 0.95rem;
      padding: 6px 12px;
    }
    .btn-cute, .btn-primary, .btn-success {
      background: #1976d2;
      color: #fff;
    }
    .btn-cute:hover, .btn-primary:hover, .btn-success:hover {
      background: #1565c0;
      color: #fff;
    }
    .btn-light {
      background: #e3f0ff;
      color: #1976d2;
    }
    .btn-light:hover {
      background: #b3e0ff;
      color: #1976d2;
    }
    #main-card, #canvas, #canvas-container {
      border-radius: 1rem !important;
    }
    #main-card {
      background: #fff;
      box-shadow: 0 8px 32px rgba(60,60,120,0.12);
      padding: 32px 8px;
      margin: 40px auto 0 auto;
      max-width: 960px;
    }
    #canvas-container {
      background: #f5f7fa;
      box-shadow: 0 2px 8px #b3e0ff44;
      padding: 8px;
      margin-bottom: 20px;
      overflow: hidden;
    }
    pinch-zoom {
      display: block;
      width: 100%;
      height: 100%;
      border-radius: 1rem !important;
    }
    #canvas {
      background: #fff;
      touch-action: none;
      width: 100%;
      max-width: 900px;
      height: 500px;
      display: block;
      margin: 0 auto;
      border: 2px solid #7ecbff;
      box-shadow: 0 2px 8px #b3e0ff44;
      border-radius: 1rem !important;
    }
    .color-btn {
      width: 36px;
      height: 36px;
      border-radius: 1rem !important;
      border: 2px solid #fff;
      margin-right: 6px;
      margin-left: 0;
      box-shadow: 0 1px 4px #b3e0ff44;
      transition: border 0.2s;
    }
    .color-btn.selected {
      border: 2px solid #1976d2;
      box-shadow: 0 2px 8px #1976d244;
    }
    #custom-color {
      width: 36px;
      height: 36px;
      border: none;
      border-radius: 1rem !important;
      margin-left: 6px;
      box-shadow: 0 1px 4px #b3e0ff44;
      padding: 0;
    }
    .brush-btn {
      border: 2px solid #b3e0ff;
      background: #fff;
      color: #1976d2;
      font-size: 1.1rem;
      margin-right: 2px;
      margin-left: 2px;
      border-radius: 1rem !important;
      transition: border 0.2s, background 0.2s;
    }
    .brush-btn.selected {
      border: 2px solid #1976d2;
      background: #e3f0ff;
    }
    #eraser-btn.selected {
      background: #ffe082;
      color: #b28704;
      border: 2px solid #b28704;
    }
    #brush-slider {
      accent-color: #1976d2;
      vertical-align: middle;
    }
    #brush-size-label {
      min-width: 32px;
      display: inline-block;
      text-align: left;
      color: #1976d2;
      font-weight: 600;
    }
    #chat-box {
      background: #e3f2fd;
      color: #222;
      border-radius: 1rem !important;
      max-height: 200px;
      overflow-y: auto;
      padding: 10px;
      margin-bottom: 10px;
      font-size: 1.05rem;
    }
    #chat-form {
      display: flex;
      gap: 8px;
      justify-content: center;
      margin-bottom: 10px;
    }
    .gallery-link {
      color: #1976d2;
      font-weight: 600;
      text-decoration: none;
      margin-left: 8px;
      font-size: 1.1rem;
    }
    .gallery-link:hover { text-decoration: underline; }
    /* Responsive toolbar */
    .toolbar-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      margin-bottom: 10px;
      margin-top: 5px;
    }
    .toolbar-group {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: center;
      margin-bottom: 4px;
    }
    @media (max-width: 900px) {
      #canvas { height: 300px; }
    }
    @media (max-width: 600px) {
      #main-card { padding: 8px 2px; }
      #canvas { height: 180px !important; max-width: 100vw; }
      .cute-title { font-size: 2rem; }
      .cute-app-title { font-size: 1.5rem; }
      .toolbar-row { flex-direction: column; gap: 4px; }
      .toolbar-group { flex-wrap: wrap; gap: 6px; }
      #toolbar-row button,
      #toolbar-row input[type="color"],
      #toolbar-row input[type="range"] {
        margin-bottom: 4px;
        max-width: 100%;
        flex: 1 1 auto;
      }
    }
    @media (max-width: 400px) {
      .toolbar-row button { width: 100%; min-width: 0; }
    }
  </style>
</head>
<body>
  <!-- Cute App Title -->
  <div class="cute-app-title text-center my-3">mdzy art place</div>

  <!-- Welcome Modal -->
  <div class="modal fade" id="welcomeModal" tabindex="-1" aria-labelledby="welcomeModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content" style="border-radius:1rem;">
        <div class="modal-body text-center py-5">
          <h1 class="cute-title mb-4">Let's draw!</h1>
          <div class="arrow mb-4">
            <svg width="40" height="40" viewBox="0 0 24 24"><path fill="#1976d2" d="M12 16.5l-8-8 1.41-1.42L12 13.67l6.59-6.59L20 8.5z"/></svg>
          </div>
          <form id="name-form" autocomplete="off" class="mb-3">
            <input type="text" id="user-name" class="form-control mb-3" placeholder="Enter your name" maxlength="16" required style="max-width:220px;display:inline-block;">
            <button id="join-btn" class="btn btn-cute btn-sm px-5 py-2" type="submit">Join</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Main App -->
  <div id="main-app">
    <div id="main-card">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <button id="leave-btn" class="btn btn-cute btn-sm" style="display:inline-block;">Leave</button>
          <a href="gallery.html" class="gallery-link" target="_blank">üé® View Gallery</a>
        </div>
        <div>
          <button id="music-toggle" class="btn btn-cute btn-sm" title="Toggle music">üîä</button>
        </div>
      </div>
      <div class="toolbar-row" id="toolbar-row">
        <div class="toolbar-group">
          <button class="color-btn btn-sm" data-color="#1976d2" style="background:#1976d2;" title="Blue"></button>
          <button class="color-btn btn-sm" data-color="#e53935" style="background:#e53935;" title="Red"></button>
          <button class="color-btn btn-sm" data-color="#43a047" style="background:#43a047;" title="Green"></button>
          <button class="color-btn btn-sm" data-color="#fbc02d" style="background:#fbc02d;" title="Yellow"></button>
          <button class="color-btn btn-sm" data-color="#8e24aa" style="background:#8e24aa;" title="Purple"></button>
          <input type="color" id="custom-color" value="#1976d2" title="Custom color">
          <button id="eraser-btn" class="btn btn-light btn-sm" title="Eraser">üßΩ</button>
        </div>
        <div class="toolbar-group">
          <span style="font-size:1.1rem;">üñåÔ∏è</span>
          <button class="brush-btn btn btn-light btn-sm" data-size="2" style="width:28px;height:28px;">‚Ä¢</button>
          <button class="brush-btn btn btn-light btn-sm" data-size="5" style="width:32px;height:32px;">‚Ä¢‚Ä¢</button>
          <button class="brush-btn btn btn-light btn-sm" data-size="10" style="width:36px;height:36px;">‚Ä¢‚Ä¢‚Ä¢</button>
          <input type="range" id="brush-slider" min="1" max="30" value="3" style="width:80px;">
          <span id="brush-size-label" style="font-size:1.1rem;">3px</span>
        </div>
        <div class="toolbar-group">
          <button id="clear-btn" class="btn btn-cute btn-sm">Clear</button>
          <button id="download-btn" class="btn btn-success btn-sm">‚¨áÔ∏è Download JPG</button>
          <button id="upload-btn" class="btn btn-primary btn-sm">‚¨ÜÔ∏è Upload</button>
        </div>
      </div>
      <div id="canvas-container">
        <pinch-zoom>
          <canvas id="canvas" width="900" height="500"></canvas>
        </pinch-zoom>
      </div>
      <div id="chat-box"></div>
      <form id="chat-form" autocomplete="off">
        <input type="text" id="chat-input" class="form-control" placeholder="Type a message..." style="max-width: 300px;">
        <button type="submit" class="btn btn-cute btn-sm">Send</button>
      </form>
    </div>
  </div>

  <!-- Background Music -->
  <audio id="bg-music" src="cute.mp3" loop></audio>

  <!-- Bootstrap JS (for modal) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Socket.IO -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script>
    // === CONFIG ===
    // CHANGE THIS to your backend URL!
    const SERVER_URL = 'https://mdzyart.onrender.com'; // <--- CHANGE THIS if needed

    // === SOCKET.IO ===
    const socket = io(SERVER_URL);

    // === Modal logic ===
    const welcomeModalEl = document.getElementById('welcomeModal');
    const welcomeModal = new bootstrap.Modal(welcomeModalEl);
    welcomeModal.show();
    let joined = false;
    let currentRoom = 'default';
    let userName = '';

    // Name form logic
    const nameForm = document.getElementById('name-form');
    const userNameInput = document.getElementById('user-name');
    nameForm.onsubmit = (e) => {
      e.preventDefault();
      const name = userNameInput.value.trim();
      if (!name) {
        userNameInput.classList.add('is-invalid');
        userNameInput.focus();
        return;
      }
      userNameInput.classList.remove('is-invalid');
      userName = name;
      joined = true;
      welcomeModal.hide();
      // Send name to backend when joining
      socket.emit('joinRoom', { room: currentRoom, name: userName });
    };

    document.getElementById('leave-btn').onclick = () => {
      joined = false;
      welcomeModal.show();
      socket.emit('leaveRoom', currentRoom);
    };

    // === Music ===
    const music = document.getElementById('bg-music');
    const musicToggle = document.getElementById('music-toggle');
    music.volume = 0.5;
    let musicOn = false;
    // Autoplay may be blocked until user interacts
    nameForm.addEventListener('submit', () => {
      setTimeout(() => {
        if (!musicOn) {
          music.play().catch(()=>{});
          musicToggle.textContent = 'üîä';
          musicOn = true;
        }
      }, 500);
    });
    musicToggle.onclick = () => {
      if (music.paused) {
        music.play();
        musicToggle.textContent = 'üîä';
        musicOn = true;
      } else {
        music.pause();
        musicToggle.textContent = 'üîà';
        musicOn = false;
      }
    };

    // === Color Picker & Eraser ===
    let currentColor = '#1976d2';
    let isEraser = false;
    function selectColor(color) {
      currentColor = color;
      isEraser = false;
      document.querySelectorAll('.color-btn').forEach(btn => {
        btn.classList.toggle('selected', btn.getAttribute('data-color') === color);
      });
      document.getElementById('custom-color').value = color;
      document.getElementById('eraser-btn').classList.remove('selected');
    }
    document.querySelectorAll('.color-btn').forEach(btn => {
      btn.onclick = () => selectColor(btn.getAttribute('data-color'));
    });
    document.getElementById('custom-color').oninput = (e) => {
      currentColor = e.target.value;
      isEraser = false;
      document.querySelectorAll('.color-btn').forEach(btn => btn.classList.remove('selected'));
      document.getElementById('eraser-btn').classList.remove('selected');
    };
    // Set initial color
    selectColor('#1976d2');

    // Eraser button
    document.getElementById('eraser-btn').onclick = () => {
      isEraser = !isEraser;
      document.getElementById('eraser-btn').classList.toggle('selected', isEraser);
      if (isEraser) {
        document.querySelectorAll('.color-btn').forEach(btn => btn.classList.remove('selected'));
      }
    };

    // === Brush Size Picker ===
    let currentBrushSize = 3;
    function selectBrush(size) {
      currentBrushSize = size;
      document.getElementById('brush-slider').value = size;
      document.getElementById('brush-size-label').textContent = size + 'px';
      document.querySelectorAll('.brush-btn').forEach(btn => {
        btn.classList.toggle('selected', parseInt(btn.getAttribute('data-size')) === size);
      });
    }
    document.querySelectorAll('.brush-btn').forEach(btn => {
      btn.onclick = () => selectBrush(parseInt(btn.getAttribute('data-size')));
    });
    document.getElementById('brush-slider').oninput = (e) => {
      currentBrushSize = parseInt(e.target.value);
      document.getElementById('brush-size-label').textContent = currentBrushSize + 'px';
      document.querySelectorAll('.brush-btn').forEach(btn => btn.classList.remove('selected'));
    };
    // Set initial brush size
    selectBrush(3);

    // === Canvas Drawing ===
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let drawing = false, last = null;

    function getPos(e) {
      const rect = canvas.getBoundingClientRect();
      let clientX, clientY;
      if (e.touches && e.touches.length > 0) {
        clientX = e.touches[0].clientX;
        clientY = e.touches[0].clientY;
      } else if (e.changedTouches && e.changedTouches.length > 0) {
        clientX = e.changedTouches[0].clientX;
        clientY = e.changedTouches[0].clientY;
      } else {
        clientX = e.clientX;
        clientY = e.clientY;
      }
      return {
        x: (clientX - rect.left) * (canvas.width / rect.width),
        y: (clientY - rect.top) * (canvas.height / rect.height)
      };
    }

    function drawLine(from, to, color = currentColor, size = currentBrushSize, isEraserDraw = isEraser, emit = true) {
      ctx.strokeStyle = isEraserDraw ? '#fff' : color;
      ctx.lineWidth = size;
      ctx.lineCap = 'round';
      ctx.beginPath();
      ctx.moveTo(from.x, from.y);
      ctx.lineTo(to.x, to.y);
      ctx.stroke();
      ctx.closePath();
      if (emit && currentRoom) {
        socket.emit('draw', { room: currentRoom, data: { from, to, color, size, isEraser: isEraserDraw } });
      }
    }

    function startDraw(e) {
      if (!currentRoom) return;
      drawing = true;
      last = getPos(e);
      e.preventDefault();
    }
    function moveDraw(e) {
      if (!drawing || !currentRoom) return;
      const pos = getPos(e);
      drawLine(last, pos, currentColor, currentBrushSize, isEraser, true);
      last = pos;
      e.preventDefault();
    }
    function endDraw(e) {
      drawing = false;
      last = null;
      if (e) e.preventDefault();
    }

    // Mouse events
    canvas.addEventListener('mousedown', startDraw);
    canvas.addEventListener('mousemove', moveDraw);
    canvas.addEventListener('mouseup', endDraw);
    canvas.addEventListener('mouseleave', endDraw);

    // Touch events
    canvas.addEventListener('touchstart', startDraw, { passive: false });
    canvas.addEventListener('touchmove', moveDraw, { passive: false });
    canvas.addEventListener('touchend', endDraw, { passive: false });
    canvas.addEventListener('touchcancel', endDraw, { passive: false });

    // Receive drawing from others
    socket.on('draw', data => {
      drawLine(data.from, data.to, data.color, data.size, data.isEraser, false);
    });

    // Receive canvas history and replay it
    socket.on('canvasHistory', history => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      history.forEach(data => {
        drawLine(data.from, data.to, data.color, data.size, data.isEraser, false);
      });
    });

    // === Clear Canvas ===
    const clearBtn = document.getElementById('clear-btn');
    function clearCanvas(emit = true) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      if (emit && currentRoom) {
        socket.emit('clear', { room: currentRoom });
      }
    }
    clearBtn.onclick = () => clearCanvas();

    socket.on('clear', () => clearCanvas(false));

    // === Download Button (JPG, white background) ===
    document.getElementById('download-btn').onclick = () => {
      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = canvas.width;
      tempCanvas.height = canvas.height;
      const tempCtx = tempCanvas.getContext('2d');
      tempCtx.fillStyle = '#fff';
      tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
      tempCtx.drawImage(canvas, 0, 0);
      const link = document.createElement('a');
      link.download = 'mdzyart-drawing.jpg';
      link.href = tempCanvas.toDataURL('image/jpeg', 0.95);
      link.click();
    };

    // === Upload Button ===
    document.getElementById('upload-btn').onclick = async () => {
      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = canvas.width;
      tempCanvas.height = canvas.height;
      const tempCtx = tempCanvas.getContext('2d');
      tempCtx.fillStyle = '#fff';
      tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
      tempCtx.drawImage(canvas, 0, 0);
      const dataUrl = tempCanvas.toDataURL('image/jpeg', 0.95);
      const res = await fetch(SERVER_URL + '/upload', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          image: dataUrl,
          name: userName || 'Anonymous',
          time: Date.now()
        })
      });
      if (res.ok) {
        alert('Uploaded to gallery!');
      } else {
        alert('Upload failed.');
      }
    };

    // === Chat ===
    const chatBox = document.getElementById('chat-box');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');

    function addMessage(msg, system = false) {
      const div = document.createElement('div');
      div.innerHTML = msg;
      if (system) div.style.fontStyle = 'italic';
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    socket.on('chat', ({ id, message, name }) => {
      const displayName = name ? `<span style="color:#1976d2;font-weight:600;">${name}</span>` : `<b>${id}</b>`;
      addMessage(`${displayName}: ${message}`);
    });
    socket.on('system', msg => addMessage(`<span style="color:#1976d2">${msg}</span>`, true));

    chatForm.onsubmit = e => {
      e.preventDefault();
      if (!currentRoom) return;
      const msg = chatInput.value.trim();
      if (!msg) return;
      socket.emit('chat', { room: currentRoom, message: msg, name: userName });
      chatInput.value = '';
    };
  </script>
</body>
</html>
